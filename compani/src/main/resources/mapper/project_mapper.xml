<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.yedam.compani.project.mapper.ProjectMapper">

	<select id="selectAllProject" resultType="ProjectVO">
	   SELECT     PM.PRJT_FAV,
			      P.PRJT_NO,
			      COUNT(PM.PRJT_NO) AS count,
			   	  P.PRJT_NM,
			   	  P.PRJT_TDT,
			   	  P.PRJT_FDT,
			   	  P.PRJT_ST
                
		 FROM  	  PROJECT_MEMBER PM,  
		          PROJECT P

		WHERE     PM.PRJT_NO = P.PRJT_NO
          AND     PM.PRJT_NO IN (SELECT PRJT_NO 
        						   FROM PROJECT_MEMBER
                                  WHERE MEMB_ID = #{membId})
        GROUP BY PM.PRJT_FAV, 
        		 P.PRJT_NO, P.PRJT_NM,P.PRJT_TDT, P.PRJT_FDT, P.PRJT_ST

		ORDER BY PRJT_FAV DESC 
	</select>

	<select id="selectProjectAndMemberList"
		resultType="CamelHashMap">
		SELECT pm.prjt_no
		, memb_id
		, prjt_memb_perm
		, prjt_nm
		, prjt_pubcyn
		,
		prjt_fdt
		, prjt_tdt
		, prjt_cmpltdt
		, prjt_st
		FROM project_member pm LEFT
		JOIN project p ON(pm.prjt_no =
		p.prjt_no)
		<where>
			<if test="memberId != null">
				AND memb_id = #{membId}
			</if>
		</where>
		ORDER BY prjt_no

	</select>

	<select id="getProjectStateList" resultType="ProjectVO">

	     SELECT   PM.PRJT_FAV,
			      P.PRJT_NO,
			      COUNT(PM.PRJT_NO) AS count,
			   	  P.PRJT_NM,
			   	  P.PRJT_TDT,
			   	  P.PRJT_FDT,
			   	  FIND_CODENM(P.PRJT_ST) as prjtStNm
                
		FROM   	  PROJECT_MEMBER PM,  PROJECT P
		WHERE     PM.PRJT_NO = P.PRJT_NO
		AND       P.PRJT_ST = #{prjtSt}
        AND       PM.PRJT_NO IN (SELECT PRJT_NO 
        						 FROM 	PROJECT_MEMBER
                                 WHERE  MEMB_ID = #{membId})
        GROUP BY PM.PRJT_FAV, P.PRJT_NO, P.PRJT_NM,P.PRJT_TDT, P.PRJT_FDT, P.PRJT_ST
		ORDER BY PRJT_FAV DESC 

	</select>
	<update id="updateFavorite" parameterType="ProjectVO">
		UPDATE PROJECT_MEMBER
		SET PRJT_FAV = #{prjtFav}
		WHERE PRJT_NO = #{prjtNo}
	</update>

	<insert id="insertProject" parameterType="ProjectVO">
		<selectKey keyProperty="prjtNo" resultType="ProjectVO"
			order="BEFORE">
			SELECT NVL(MAX(PRJT_NO),0) +1 AS PRJT_NO FROM PROJECT
		</selectKey>
		INSERT INTO PROJECT(
		PRJT_NO,
		CO_CD,
		PRJT_NM,
		PRJT_PUBCYN,
		PRJT_FDT,
		PRJT_TDT
		)
		VALUES(
		#{prjtNo},
		#{coCd},
		#{prjtNm},
		#{prjtPubcyn},
		#{prjtFdt},
		#{prjtTdt}
		)
	</insert>

	<select id="projectSelect" resultType="CamelHashMap">
		SELECT 	 p.PRJT_NO AS PRJT_NO,
				 p.PRJT_NM AS PRJT_NM,
			  	 'D-'||FLOOR(p.prjt_Tdt -SYSDATE) AS "DATE",
			     p.PRJT_ST ,
			     p.PRJT_PUBCYN ,
			     COUNT(b.BUSS_NO) AS COUNT,
			     p.PRJT_FDT,
			     p.PRJT_TDT
	
		FROM     PROJECT p, BUSINESS b
		WHERE    p.prjt_NO = b.PRJT_NO(+)
		AND      p.PRJT_NO = #{prjtNo}
		GROUP BY p.PRJT_NO, p.PRJT_NM ,p.PRJT_TDT, p.PRJT_ST, p.PRJT_PUBCYN, p.PRJT_FDT, p.PRJT_TDT

	</select>
	
	<update id="updateProject" parameterType="ProjectVO">
		UPDATE project
		<set>
			<if test="prjtSt == '0D2'">
				prjt_cmpltdt = sysdate,
			</if>
			  prjt_nm     = #{prjtNm},
			  prjt_pubcyn = #{prjtPubcyn},
			  prjt_fdt    = #{prjtFdt},
			  prjt_tdt    = #{prjtTdt},
			  PRJT_ST    = #{prjtSt}
		</set>
		WHERE  prjt_no     = #{prjtNo}
	
	</update>
	
	<select id="updateCheck" resultType="ProjectMemberVO">
		SELECT pm.memb_id 	
		FROM   PROJECT_MEMBER pm, PROJECT p
		WHERE  pm.prjt_No = p.prjt_No
		AND    pm.prjt_NO  = #{prjtNo}
		AND    pm.memb_id =  #{membId}
		AND    p.PRJT_ST not in ('0D2')
	</select>
	
	<select id="findCompanyProject" resultType="ProjectVO">
		SELECT P.PRJT_NO,
			   P.PRJT_NM,
			   COUNT(pm.PRJT_NO) AS count,
			   P.PRJT_PUBCYN,
			   FIND_CODENM(P.PRJT_PUBCYN) AS prjtPubcynNm,
			   P.PRJT_FDT,
			   P.PRJT_TDT,
			   P.PRJT_CMPLTDT,
			   P.PRJT_ST,
			   FIND_CODENM(P.PRJT_ST) AS prjtStNm
		FROM   	  PROJECT_MEMBER PM,  PROJECT P
		WHERE  PM.PRJT_NO = P.PRJT_NO
  		AND    p.CO_CD = #{coCd}
  		 <choose>
			<when test="keyword == '제목'">
				 AND prjt_nm LIKE '%' || #{search} || '%'
			</when>
			<when test="keyword == '전체'">
				 AND (prjt_nm LIKE '%' || #{search} || '%'
				 OR  prjt_St  LIKE '%' || #{search} || '%')
			</when>
		</choose> 
        GROUP BY P.PRJT_NO, 
        	  P.PRJT_NM,P.PRJT_PUBCYN, P.PRJT_TDT, P.PRJT_FDT,PRJT_CMPLTDT, P.PRJT_ST
        	  
        	  
	</select>
	
</mapper>