<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/layout}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<style>
.editBtn{
	cursor:pointer;
}

.delBtn{
	cursor:pointer;
	margin-right:3%;

}

.submitBtn{
	margin-right:3%;
	cursor:pointer;
	display:none;
	color:blue;
}

</style>

</head>

<body>
<th:block layout:fragment="content">
	<div class="row">
		<div class="col-lg-8">
		<div class="column">
			<div>
				<div class="row">
			        <div class="col-lg-2">
			            <div class="card">
			                <div class="card-body">
								<h4 class="card-title">총 소요일수</h4>
								<span th:text="${projectStatus.prjtStatDtCnt}">
								</span>
			                </div>
			            </div>
			        </div>
			        <div class="col-lg-2">
			            <div class="card">
			                <div class="card-body">
								<h4 class="card-title">참여자</h4>
								<span th:text="${projectStatus.prjtMembCnt}">
								</span>
			                </div>
			            </div>
			        </div>
			        <div class="col-lg-2">
			            <div class="card">
			                <div class="card-body">
								<h4 class="card-title">총 업무개수</h4>
								<span th:text="${projectStatus.bussCnt}">
								</span>
			                </div>
			            </div>
			        </div>
			        <div class="col-lg-2">
			            <div class="card">
			                <div class="card-body">
								<h4 class="card-title">완료한 업무</h4>
								<span th:text="${projectStatus.bussCmplCnt}">
								</span>
			                </div>
			            </div>
			        </div>
			        <div class="col-lg-2">
			            <div class="card">
			                <div class="card-body">
								<h4 class="card-title">초과완료한 업무</h4>
								<span th:text="${projectStatus.bussExceCnt}">
								</span>
			                </div>
			            </div>
			        </div>
			        <div class="col-lg-2">
			            <div class="card">
			                <div class="card-body">
								<h4 class="card-title">미완료한 업무</h4>
								<span th:text="${projectStatus.bussUncmplCnt}">
								</span>
			                </div>
			            </div>
			        </div>
				</div>
				<div class="row">
			        <div class="col-lg-3">
			            <div class="card">
			                <div class="card-body">
								<h4 class="card-title">총 이슈 개수</h4>
								<span th:text="${projectStatus.issuCnt}">
								</span>
			                </div>
			            </div>
			        </div>
			        <div class="col-lg-3">
			            <div class="card">
			                <div class="card-body">
								<h4 class="card-title">해결 이슈</h4>
								<span th:text="${projectStatus.issuSolveCnt}">
								</span>
			                </div>
			            </div>
			        </div>
			        <div class="col-lg-3">
			            <div class="card">
			                <div class="card-body">
								<h4 class="card-title">미해결 이슈</h4>
								<span th:text="${projectStatus.issuUnsolveCnt}">
								</span>
			                </div>
			            </div>
			        </div>
			        <div class="col-lg-3">
			            <div class="card">
			                <div class="card-body">
								<h4 class="card-title">해결불가 이슈</h4>
								<span th:text="${projectStatus.issuUnsolvableCnt}">
								</span>
			                </div>
			            </div>
			        </div>
				</div>
			</div>
			<!-- Project Status Chart Area -->
			<div>
			    <div class="col-lg-12">
		            <div class="card">
		                <div class="card-body">
		                    <h4 class="card-title">업무 통계</h4>
		                    <div class="row">
		        				<div class="col-lg-7">
		                    	<canvas id="bussDonutChart" width="300" height="250"></canvas>
		                    	</div>
		        				<div class="col-lg-5">
		                    	<canvas id="bussStBar" width="200" height="300"></canvas>
		                    	</div>    
		                    </div> 
		                </div>
		            </div>
		        </div>
			</div>
			<!-- Project Status Chart Area End -->
			<!-- Issue Status Chart Area -->
			<div>
			    <div class="col-lg-12">
			        <div class="card">
			            <div class="card-body">
			            	<h4 class="card-title">이슈 통계</h4>
		                    <div class="row">
		        				<div class="col-lg-7">
		                    	<canvas id="issuDonutChart" width="300" height="250"></canvas>
		                    	</div>
		        				<div class="col-lg-5">
		                    	<canvas id="issuStBar" width="200" height="300"></canvas>
		                    	</div>    
		                    </div>              
			            </div>
			        </div>
			    </div>
			</div>
		</div>
		</div>
		<!-- Issue Status Chart Area End -->
		<!-- Comemnt Area -->
	    <div class="col-lg-4">
	        <div class="card"  style="height:80vh;">
	        	<div class="card-header bg-white">
                    <h5 class="card-title">Card title</h5>
                    <h6 class="card-subtitle mb-2 text-muted">Card subtitle</h6>
                </div>
	            <div class="card-body" style="overflow-y:auto; background-color:#FAFAFA;" id="commentBody">
					<th:block th:each="feedback : ${projectFeedbackList}">
						<div class="card">
							<div class="card-body">
								<div class="media">
									<div class="media-body">
										<!-- Comment Area Start -->
										<div class="comment-content" th:data-no="${feedback.prjtFdbkNo}">
											<h5 class="mt-0" th:text="${feedback.membNm}"></h5>
											
											<div class="content-area">
												<th:block th:switch="${feedback.prjtFdbkShow}">
													<th:block th:case="0N1" th:text="${feedback.prjtFdbkCntn}"></th:block>	
													<th:block th:case="0N2">삭제된 내용입니다.</th:block>	
												</th:block>
											</div>
											<div class="edit-area" style="display:none;">
												<textarea class="form-control" id="editCntn" th:text="${feedback.prjtFdbkCntn}"></textarea>
											</div>
											<div style="margin-top:3%" class="btn-area" th:if="${feedback.prjtFdbkShow} == '0N1'">
												<div th:text="${#dates.format(feedback.prjtFdbkDt,'yyyy-MM-dd HH:mm')}" class="float-left" id="date-area"></div>
												<div th:text="수정" class="float-right editBtn"></div>
												<div th:text="삭제" class="float-right delBtn"></div>
												<div th:text="확인" class="float-right submitBtn"></div>
											</div>
										</div>
										<!-- Comment Area End -->
									</div>
								</div>
							</div>
						 </div>
					</th:block>
	            </div>
				<!-- 댓글 등록 영역 -->
	            <div class="card-footer">
					<textarea class="form-control" name="inputCntn" id="inputCntn" cols="30" rows="2" placeholder="Post a new message" style="height: 56px;"></textarea>
		            <button id="insertBtn" class="btn btn-primary px-3 ml-4">Send</button>
	            </div>
				<!-- 댓글 등록 영역 End -->
	        </div>
	    </div>
	    <!-- Comment Area End -->
	</div>

	<div id="replyArea" style="display:none;">
		<div class="media mt-3">
			<textarea class="form-control" name="inputCntn" id="inputCntn" cols="30" rows="2" placeholder="Post a new message" style="height: 56px;"></textarea>
		    <button id="insertBtn" class="btn btn-primary px-3 ml-4">Send</button>
		</div>
	</div>
	
	<script th:inline="javascript">
		// -------------------- Status Data Start
		const projectStatus = [[${projectStatus}]];
		const cpnStatForCurrDt = [[${cpnStatForCurrDt}]];
		const cpnStatForPrjtDt = [[${cpnStatForPrjtDt}]];
		const prjtNo = [[${prjtNo}]];
		const membNm = 'm1';
		// -------------------- Status Data End
	</script>
	
	<script th:inline="javascript" th:src="@{/js/project-feedback-chart.js}"></script>
	
	<script th:inline="javascript">
	
	//----------------------- Project Feedback(Comment) Insert Start
		function insertComment(){
			let value = $('#inputCntn').val();
			let obj = {};
			obj["prjtFdbkCntn"] = value;
			obj["prjtNo"] = prjtNo;
			
			insertAjax(obj);
			
			$('#inputCntn').val('');
		}
		
		function insertAjax(obj){
            $.ajax({
                url:'/project/feedback',
                type: 'post',
                contentType: "application/json",
                data:JSON.stringify(obj)
            })
            .done(data => {insertCommentHTML(data)})
            .fail(err => {});
		}
		
		function insertCommentHTML(data){
			// create tag
			let body = $('#commentBody');
			let card = body.find('.card').first().clone();
			
			// input content values
			card.find('comment-content').data('no',data.prjtFdbkNo);
			card.find('.mt-0').text(membNm);
			card.find('.content-area').text(data.prjtFdbkCntn);
			card.find('textarea').text(data.prjtFdbkCntn);
			card.find('#date-area').text(timestamp(data.prjtFdbkDt));
			
			// insert comment tag to comment body
			body.append(card);
		}
		
		$('#insertBtn').on('click', insertComment);
		
		// ---------------------------------------Project Feedback(Comment) Insert End
		
		// date, content change
		function changeComment(data, comment){
			let text = (data.prjtFdbkShow == null) ? data.prjtFdbkCntn : '삭제되었습니다.'; 

			if (data.prjtFdbkShow == null){
				comment.find(".content-area").text(data.prjtFdbkCntn);
				comment.find("#date-area").text(timestamp(data.prjtFdbkDt));
			} else {
				comment.find(".content-area").text('삭제된 내용입니다.');
				comment.find(".btn-area").remove();
			}
		}
		
		// get comment, content, editBtn, submitBtn to Toggle
		// update textarea - copy to content text
		function toggleTags(event){
			let comment = $(event.target).closest('.comment-content');
			let content = comment.find('.content-area');
			let edit = comment.find('.edit-area');
			let submitBtn = comment.find('.submitBtn');
			
			content.val(comment.find('textarea').val());
			
			content.toggle();
			edit.toggle();
			submitBtn.toggle();
		}
		
		function editSubmit(event){
			let comment = $(event.target).closest('.comment-content');
			let textCntn = comment.find("textarea");
			
			let obj = {};
			obj["prjtFdbkCntn"] = textCntn.val();
			obj["prjtFdbkNo"] = comment.data('no');
			updateAjax(obj, comment);
			
			toggleTags(event);
		}
		
		// ----------------------------------Delete Comment
		function deleteComment(event){
			let comment = $(event.target).closest('.comment-content');
			
			let obj = {};
			obj["prjtFdbkShow"] = '0N2';		// Delete State Change
			obj["prjtFdbkNo"] = comment.data('no');
			
			updateAjax(obj,comment);
		}
		// ----------------------------------Delete Comment 
		
		// ----------------------------------Update Ajax
		// update - using edit, delete
		function updateAjax(obj, comment){
			$.ajax({
				url:'/project/feedback',
                type: 'put',
                contentType: "application/json",
                data:JSON.stringify(obj)
			})
            .done(data => {changeComment(data, comment)})
            .fail(err => {});
		}
		// -------------------------------Update Ajax End
		
		// -------------------------------onclick Event
		$(document).on('click','.delBtn',deleteComment);
		$(document).on('click','.editBtn',toggleTags);
		$(document).on('click','.submitBtn',editSubmit);
		// ------------------------------onclick Event End
		
		//------------ Date formatting
		function timestamp(convertDate){
		    let today = new Date(convertDate);
		    today.setHours(today.getHours() + 9);
		    return today.toISOString().replace('T', ' ').substring(0, 16);
		}
		
	</script>
</th:block>
</body>
</html>