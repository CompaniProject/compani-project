<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/projectlayout}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="/plugins/nouislider/nouislider.min.css">
</head>
<body>
	<th:block layout:fragment="content">
		<div>
			[[${session.loginInfo}]]
			<!-- Bussiness Header -->
			<div class="row mx-0">
				<ul class="nav nav-pills mb-3">
					<li class="nav-item"><a href="#kanbanBoard"
						class="nav-link active" data-toggle="tab" aria-expanded="false">칸반보드</a>
					</li>
					<li class="nav-item"><a href="#businessList" class="nav-link"
						data-toggle="tab" aria-expanded="false">리스트</a></li>
				</ul>
				<div class="col p-md-0">
					<!-- 	<button type="button" class="btn mb-1 btn-primary float-right"
						data-toggle="modal" id="insertBtn">업무 추가</button> -->
					<!-- <button type="button" id="insertModal"
						class="btn mb-1 btn-primary float-right" data-toggle="modal"
						data-target=".bd-example-modal-lg">업무추가</button> -->
					<button type="button" id="insertModal"
						class="btn mb-1 btn-primary float-right">업무추가</button>
				</div>
			</div>
			<!-- Bussiness Header End -->

			<div class="tab-content br-n pn">
				<div id="kanbanBoard" class="tab-pane active show">
					<!-- Kanban board -->
					<div class="row flex-row flex-sm-nowrap py-3">
						<div class="col-sm-6 col-md-4 col-xl-3">
							<div class="card">
								<div class="card-body">
									<h6 class="card-title text-uppercase text-truncate py-2">진행중</h6>
									<div class="items border-light">
										<!-- Card Body -->
										<th:block th:each="business : ${businessLevelList}"
											th:if="${business.bussSt == '0K1'}">
											<div class="card shadow-sm border">
												<div class="card-body p-3">
													<input type="hidden" id="bussNo"
														th:value="${business.bussNo}" />
													<div class="card-title">
														<a href="" th:text="${business.bussNm}"></a>
													</div>
													<div style="padding-top: 10px; padding-bottom: 10px;">
														<div class="progress" style="height: 10px">
															<div class="progress-bar gradient-1"
																th:style="|width:${business.bussPrgre}%;|"
																role="progressbar"></div>
														</div>
													</div>
													<div>
														<span
															th:class="${business.dDay < 0} ? 'badge badge-danger px-2' : 'badge badge-primary px-2' "
															th:text="${business.dDay < 0} ? |지연 + ${-business.dDay}|: |D-${business.dDay}|"></span>

														<th:block th:switch="${business.bussImp}">
															<th:block th:case="0J1">
																<span class="badge badge-pill badge-danger px-2">상</span>
															</th:block>
															<th:block th:case="0J2">
																<span class="badge badge-pill badge-warning px-2">중</span>
															</th:block>
															<th:block th:case="0J3">
																<span class="badge badge-pill badge-info px-2">하</span>
															</th:block>
														</th:block>
													</div>
												</div>
											</div>
										</th:block>
									</div>
								</div>
							</div>
						</div>
						<div class="col-sm-6 col-md-4 col-xl-3">
							<div class="card">
								<div class="card-body">
									<h6 class="card-title text-uppercase text-truncate py-2">완료</h6>
									<th:block th:each="business : ${businessLevelList}"
										th:if="${business.bussSt == '0K2'}">
										<div class="card shadow-sm border">
											<div class="card-body p-3">
												<input type="hidden" id="bussNo"
													th:value="${business.bussNo}" />
												<div class="card-title">
													<a href="" th:text="${business.bussNm}"></a>
												</div>
												<div style="padding-top: 10px; padding-bottom: 10px;">
													<div class="progress" style="height: 10px">
														<div class="progress-bar gradient-1"
															th:style="|width:${business.bussPrgre}%;|"
															role="progressbar"></div>
													</div>
												</div>
												<div>
													<span class="badge badge-success px-2" th:text="완료"></span>
													<th:block th:switch="${business.bussImp}">
														<th:block th:case="0J1">
															<span class="badge badge-pill badge-danger px-2">상</span>
														</th:block>
														<th:block th:case="0J2">
															<span class="badge badge-pill badge-warning px-2">중</span>
														</th:block>
														<th:block th:case="0J3">
															<span class="badge badge-pill badge-info px-2">하</span>
														</th:block>
													</th:block>
												</div>
											</div>
										</div>
								</div>
							</div>
						</div>
						<div class="col-sm-6 col-md-4 col-xl-3">
							<div class="card">
								<div class="card-body">
									<h6 class="card-title text-uppercase text-truncate py-2">초과완료</h6>
									<th:block th:each="business : ${businessLevelList}"
										th:if="${business.bussSt == '0K4'}">
										<div class="card shadow-sm border">
											<div class="card-body p-3">
												<input type="hidden" id="bussNo"
													th:value="${business.bussNo}" />
												<div class="card-title">
													<a href="" th:text="${business.bussNm}"></a>
												</div>
												<div style="padding-top: 10px; padding-bottom: 10px;">
													<div class="progress" style="height: 10px">
														<div class="progress-bar gradient-1"
															th:style="|width:${business.bussPrgre}%;|"
															role="progressbar"></div>
													</div>
												</div>
												<div>
													<span class="badge badge-success px-2"
														th:text="|${business.endDelayDay}일 초과|"></span>
													<th:block th:switch="${business.bussImp}">
														<th:block th:case="0J1">
															<span class="badge badge-pill badge-danger px-2">상</span>
														</th:block>
														<th:block th:case="0J2">
															<span class="badge badge-pill badge-warning px-2">중</span>
														</th:block>
														<th:block th:case="0J3">
															<span class="badge badge-pill badge-info px-2">하</span>
														</th:block>
													</th:block>
												</div>
											</div>
										</div>
								</div>
							</div>
						</div>
						<div class="col-sm-6 col-md-4 col-xl-3">
							<div class="card">
								<div class="card-body">
									<h6 class="card-title text-uppercase text-truncate py-2">초과</h6>
									<th:block th:each="business : ${businessLevelList}"
										th:if="${business.bussSt == '0K3'}">
										<div class="card shadow-sm border">
											<div class="card-body p-3">
												<input type="hidden" id="bussNo"
													th:value="${business.bussNo}" />
												<div class="card-title">
													<a href="" th:text="${business.bussNm}"></a>
												</div>
												<div style="padding-top: 10px; padding-bottom: 10px;">
													<div class="progress" style="height: 10px">
														<div class="progress-bar gradient-1"
															th:style="|width:${business.bussPrgre}%;|"
															role="progressbar"></div>
													</div>
												</div>
												<div>
													<span
														th:class="${business.dDay < 0} ? 'badge badge-danger px-2' : 'badge badge-primary px-2' "
														th:text="${business.dDay < 0} ? |지연 + ${-business.dDay}|: |D-${business.dDay}|">
													</span>

													<th:block th:switch="${business.bussImp}">
														<th:block th:case="0J1">
															<span class="badge badge-pill badge-danger px-2">상</span>
														</th:block>
														<th:block th:case="0J2">
															<span class="badge badge-pill badge-warning px-2">중</span>
														</th:block>
														<th:block th:case="0J3">
															<span class="badge badge-pill badge-info px-2">하</span>
														</th:block>
													</th:block>
												</div>
											</div>
										</div>
								</div>
							</div>
						</div>
					</div>
					<!-- Kanban board End -->
				</div>

				<div id="businessList" class="tab-pane">
					<!-- Business List -->
					<div class="row">
						<div class="col-lg-12">
							<div class="card">
								<div class="card-body">
									<h4 class="card-title">업무 목록</h4>
									<div class="table-responsive">
										<table class="table">
											<thead>
												<tr>
													<th scope="col">업무명</th>
													<th scope="col">일정</th>
													<th scope="col">진행률</th>
													<th scope="col">&nbsp</th>
													<th scope="col">상태</th>
												</tr>
											</thead>
											<tbody>
												<tr th:each="business : ${businessLevelList}">
													<td><th:block
															th:each="i : ${#numbers.sequence(3,business.level,1)}">
															<span>&nbsp;&nbsp;&nbsp;</span>
														</th:block> <th:block th:if="${business.level > 1}">
															<i class="bi bi-arrow-return-right"></i>
														</th:block> <span th:utext="${business.bussNm}"></span></td>
													<th:block th:switch="${business.bussSt}">
														<th:block th:case="0K1">
															<td th:text="|D-${business.dDay}|"></td>
														</th:block>
														<th:block th:case="0K3">
															<td th:text="|지연 + ${-business.dDay}|"
																style="color: red;"></td>
														</th:block>
														<th:block th:case="0K2">
															<td style="color: green;">완료</td>
														</th:block>
														<th:block th:case="0K4">
															<td style="color: green;"
																th:text="|${business.endDelayDay}일 초과|"></td>
														</th:block>
													</th:block>
													<td>
														<div class="progress" style="height: 10px">
															<div class="progress-bar gradient-1"
																th:style="|width:${business.bussPrgre}%;|"
																role="progressbar"></div>
														</div>
													</td>
													<td><span class="label gradient-1 btn-rounded"
														th:text="|${business.bussPrgre}%|"></span></td>
													<td><th:block th:switch="${business.bussSt}">
															<span th:case="0K1" th:text="진행중"
																class="badge badge-info px-2"></span>
															<span th:case="0K2" th:text="완료"
																class="badge badge-success px-2"></span>
															<span th:case="0K3" th:text="초과"
																class="badge badge-danger px-2"></span>
															<span th:case="0K4" th:text="초과완료"
																class="badge badge-light px-2"></span>
														</th:block></td>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!--  -->
			</div>

		</div>

		<!--  업무 등록 모달  -->
		<div class="modal fade bd-example-modal-lg" id="insertbuss"
			tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">
							<span>&times;</span>
						</button>
					</div>
					<div class="modal-body">

						<form id="insertform" class="form-valide" action="#" method="post">
							<div>
								<div class="issueNameEdit">
									<div class="issueNameBack">
										<textarea class="modalIssueNameUpdate" id="bussNm"
											name='bussNm' maxlength="200" style="height: 34px;"
											placeholder="업무명을 입력하세요."></textarea>
									</div>
								</div>

								<div>

									<div class="card" style="height: 200px;">
										<div class="card-body" style="overflow: auto;">
											<div class="table-responsive">
												<table class="table">
													<thead>
														<tr>
															<th>프로필</th>
															<th>부서</th>
															<th>직책</th>
															<th>이름</th>
															<th>삭제</th>
														</tr>
													</thead>
													<tbody id="insertmembertbl">

													</tbody>
												</table>
											</div>

										</div>
									</div>
									<div>
										<div class="card" style="height: 200px;">
											<div class="card-body" style="overflow: auto;">
												<div class="SearchBox" style="height: 50%">
													<label for="SearchToggleCheckBox"
														th:attr="onclick='searchMember()'"></label> <input
														type="hidden" id="keyword" value="전체">
													<div class="SearchInputBox" style="width: 270px;">
														<div>
															<div class="member-selectBox" style="width: 100px;">
																<div class="member-selected" id="member-selected">
																	<div class="member-selected-value">전체</div>
																	<div class="arrow"></div>
																</div>
																<ul class="member-select-ul"
																	style="width: 100px; top: 20%; display: none;">
																	<li class="member-select-option" data-value="전체">전체</li>
																	<li class="member-select-option" data-value="부서">부서</li>
																	<li class="member-select-option" data-value="직책">직책</li>
																	<li class="member-select-option" data-value="이름">이름</li>
																</ul>
															</div>

														</div>
														<input class="SearchInputModalView" id="search"
															type="text" placeholder="검색어를 입력하세요." />
													</div>

												</div>
												<div class="table-responsive">
													<table class="table">
														<thead>
															<tr>
																<th>프로필</th>
																<th>부서</th>
																<th>직책</th>
																<th>이름</th>
																<th>추가</th>
															</tr>
														</thead>
														<tbody id="membertbl">
															<th:block th:each="memberList : ${memberList}">
																<!--  <input type="hidden" name="membId" th:value="${memberList.membId}" />-->
																<tr th:id="${memberList.membId}">
																	<td><img
																		th:src="@{/images/profile/}+${memberList.membPhtPath}"
																		height="50px" width="50px" alt="프로필"
																		th:if="${memberList.membPhtPath != null}" /></td>
																	<td th:text="${memberList.membDept}" />
																	<td th:text="${memberList.membWkgd}" />
																	<td th:text="${memberList.membNm}" />
																	<td><i class="fa-solid fa-plus"></i></td>
																</tr>
															</th:block>
														</tbody>
													</table>
												</div>

											</div>
										</div>
									</div>
								</div>

								<div class="form-group row">
									<label class="col-lg-4 col-form-label">일정 </label>
									<div class="col-lg-3">
										<input type="date" class="form-control" id="bussFrdt"
											name="bussFrdt">
									</div>
									<div class="col-lg-1">
										<label class="col-lg-4 col-form-label">~ </label>

									</div>
									<div class="col-lg-3">
										<input type="date" class="form-control" id="bussTodt"
											name="bussTodt">
									</div>
								</div>

								<div class="form-group row">
									<label class="col-lg-4 col-form-label" for="val-username">중요도
									</label>
									<div class="col-lg-6">
										<div class="dropdown custom-dropdown">
											<select class="dropdown-import" name="bussImp">
												<option class="dropdown-import" value="0J1">상</option>
												<option class="dropdown-import" value="0J2">중</option>
												<option class="dropdown-import" value="0J3">하</option>

											</select>

										</div>
									</div>
								</div>

								<label class="col-lg-4 col-form-label" for="val-username">종속관계

								</label>
								<div class="col-lg-6">
									<div class="dropdown custom-dropdown">
										<div>
											<select class="dropdown-relation" name="bussDep">
												<option class="dropdown-relation" value="">선택</option>
												<option class="dropdown-relation" value="up">선행 작업</option>
												<option class="dropdown-relation" value="down">후속
													작업</option>

											</select>
										</div>
									</div>

									<div class="dropdown custom-dropdown">
										<div>
											<select class="dropdown-relation" name="bussUpNm">
												<th:block th:each="bussNameList : ${businessNameList}">
													<option class="dropdown-business"
														th:value="${bussNameList.bussNm}"
														th:text="${bussNameList.bussNm}"></option>
												</th:block>
											</select>
										</div>
									</div>
								</div>

							</div>
							<div>
								<input type="hidden" name="prjtNo" th:value="1" />
							</div>
							<div class="modal-footer">
								<button id="insertBtn" type="button" class="btn btn-primary">등록</button>
							</div>

						</form>

					</div>
				</div>
			</div>
		</div>
		<div data-include1="showModalMain"></div>

		<script th:inline="javascript">
			$('#membertbl').on('click', 'td:nth-child(5)',insertMember)
			$('#insertmembertbl').on('click','td:nth-child(5)' ,deleteMember)
			$('#keyword').on('click', searchMember)
		 	$('.dropdown-import').on('click', dropdown)
			$('.dropdown-relation').on('click', dropdown)
			$('.dropdown-business').on('click', dropdown)
			 
			$('#insertBtn').on('click',insertBusiness)
			
			//업무 등록 모달
			$('#insertModal').on('click', businessModal)
			//업무 칸반보드 클릭시 모달
			$('.card-body.p-3').on('click', infoBusiness)
			
			$('.member-selectBox').on('click', function () {
				$('.member-select-ul').css('display', 'block');
			})
			
			$('.member-select-option').on('click', function (e) {
				
				var selectValue = e.currentTarget.textContent;
				$('.member-selected-value').text(selectValue);
				$('#keyword').val(selectValue);
				$('.member-select-ul').css('display', 'none');
				e.stopPropagation();
			})
			
		 	$(function(){
            var includes1 = $('[data-include1="showModalMain"]');
            jQuery.each(includes1, function(){
               $(this).load('/modal/modal-home.html');
            	});
    		})
			
			function businessModal(){
				$('#insertbuss').modal('show');
			} 

			function dropdown(){
				$(this).parent().siblings().attr('class', $(this).children().attr('class'));
				$(this).parent().siblings().text($(this).text());
				//$(this).parent().siblings().append('<i class="fa fa-angle-down m-l-5"></i>');
			}
			function insertMember(event){
	
				//tr의 ID -중복체크를 위한 값 
				let id = $(this).parent().attr('id');
				
				let image = $(this).siblings().eq(0).children().attr('src');
				let dept = $(this).siblings().eq(1).text();
				let position = $(this).siblings().eq(2).text();
				let name = $(this).siblings().eq(3).text();
				
				let isDup = true;				
				$('#insertmembertbl tr').each(function(){
					 let checkId = $(this).attr('id');
					 if(checkId == id){
						 isDup = false;
					 }
				})
				
				if (isDup){
					
				 	let insertmemtbl = $('#insertmembertbl');
				
					let trTag = $('<tr/>');
					let tdTag= $('<td/>');
					
					trTag.attr('id', id);
					
					if(image != null){
						let imgTag = $('<img>',{
							src:image,
							height:"50px", 
							width:"50px"
						})
						
						tdTag.append(imgTag);
					}
					trTag.append(tdTag);
					
					tdTag= $('<td/>');
					tdTag.append(dept);
					trTag.append(tdTag);
					
					tdTag= $('<td/>');
					tdTag.append(position);
					trTag.append(tdTag);
				
					tdTag= $('<td/>');
					tdTag.append(name);
					trTag.append(tdTag);
					
					tdTag= $('<td/>');
					tdTag.append('<i class="fa-solid fa-minus"></i>');
					trTag.append(tdTag);
					
					let inputTag = $('<input/>');
					inputTag.attr('type', 'hidden');
					inputTag.attr('name', 'memId');
					inputTag.attr('value', id);
					trTag.append(inputTag);
					
					insertmemtbl.append(trTag); 
				}
			}
			
			function deleteMember(event){
				$(this).parent().remove();
			}
		
			function searchMember(){
				let selected = $('.member-selected-value').first().text();
				let search  = $('#search').val();
		
				$.ajax('/memSearchAjax?&key='+selected + '&value=' + search)
				.done(function(data){
					let tbody = $('#membertbl');
					tbody.empty();
					$.each( data, function(idx,data){
	
					 	let trTag = $('<tr/>');
					 	let tdTag = $('<td/>');
					 	
						trTag.attr('id', data.MEMB_ID);
				
						if(data.MEMB_PHT_PATH != null){
						let imgTag = $('<img>',{
							src:"/images/profile/" +data.MEMB_PHT_PATH,
							height:"50px", 
							width:"50px",
						})
			
					 		tdTag.append(imgTag);
						}
					 	trTag.append(tdTag);
					 	
					 	tdTag = $('<td/>');
					 	tdTag.append(data.MEMB_DEPT);
					 	trTag.append(tdTag);
					 	
					 	tdTag = $('<td/>');
					 	tdTag.append(data.MEMB_WKGD);
					 	trTag.append(tdTag);
					 	
					 	tdTag = $('<td/>');
					 	tdTag.append(data.MEMB_NM);
					 	trTag.append(tdTag);
					
					 	tdTag = $('<td/>');
					 	tdTag.append('<i class="fa-solid fa-plus"></i>');
					 	trTag.append(tdTag);
					 	
					 	tbody.append(trTag);
					})
				})
				.fail(err =>  console.log(err));
			}
			
			
			function insertBusiness(){
				
				let formData = $('#insertform').serializeArray();

			 	let formObj = {};
			 	let memberArray = [];
				$.each(formData, function(idx,obj){
		 		  	if(obj.name != "memId"){
						formObj[obj.name] = obj.value;
					}  
		 		  	else{
						memberArray.push({membId : obj.value});
				    }
				});
			
				let obj = {};
			
				obj["business"] = formObj;
				obj["businessMember"] = memberArray;
				
				$.ajax('/insertBusiness' ,{
					type : 'post',
					contentType : 'application/json',
					data : JSON.stringify(obj)
				})
				.done(data => {
					console.log(data);
				})
				.fail(err => {});
					
			}
			function infoBusiness(e){
				$('#workModal').modal('toggle');
			}
		
	
		</script>
	</th:block>
</body>
</html>